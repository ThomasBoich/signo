
{% extends 'index.html' %}
{% load mathfilters %}

{%block content%}
  <div class="row row-deck row-cards">
    {%if request.user.is_superuser == True%}
      <!-- <div class="row row-cards mt-3 mb-3">
        <div class="card">
          <div class="card-body p-2 text-center">
            <div class="h1 m-0">{{all_users}}</div>
            <div class="text-muted mb-3">Пользователи</div>
          </div>
      </div> -->
      <div class="index-statistics mb-5">
      <div class="row mt-5">
        <div class="col-sm-12 mb-3">
          <div class="top-info-line text-muted" style="justify-content:center; font-size:1.7rem;padding:10px">Статистика</div>
        </div>
      </div>
      <div class="row mb-5">
        <!-- <div class="col-sm-4 text-center top-info-box">
          <div class="h1 m-0 mt-3">{{all_users}}</div>
          <div class="text-muted mb-3" style="font-size:1.5rem">Пользователи</div>
        </div> -->
        <div class="col-sm-4" style="display:flex; flex-direction:column; gap: 10px">
          <div class="top-info-line"><span class="text-muted">Aдминов в системе</span><span class='top-info-line-value'>{{all_admins}}</span></div>
          <div class="top-info-line"><span class="text-muted">Количество документов, <br>подписанных админами</span><span class='top-info-line-value'>{{docs_signed_by_admins}}</span></div>
          <div class="top-info-line"><span class="text-muted">Количество документов, <br>не подписанных админ </span><span class='top-info-line-value'>{{docs_not_signed_by_admins}}</span></div>
        </div>
        <div class="col-sm-4" style="display:flex; flex-direction:column; gap: 10px">
          <div class="top-info-line"><span class="text-muted">Врачей в системе: </span><span class='top-info-line-value'>{{all_doctors}}</span></div>
          <div class="top-info-line"><span class="text-muted">Количество документов, <br>подписанных врачами</span><span class='top-info-line-value'>{{docs_signed_by_doctors}}</span></div>
          <div class="top-info-line"><span class="text-muted">Количество документов, <br>не подписанных врачами</span><span class='top-info-line-value'>{{docs_not_signed_by_doctors}}</span></div>
        </div>
        <div class="col-sm-4" style="display:flex; flex-direction:column; gap: 10px">
          <div class="top-info-line"><span class="text-muted">Клиентов в системе: </span><span class='top-info-line-value'>{{all_clients}}</span></div>
          <div class="top-info-line"><span class="text-muted">Количество документов, <br>подписанных клиентами</span><span class='top-info-line-value'>{{docs_signed_by_clients}}</span></div>
          <div class="top-info-line"><span class="text-muted">Количество документов, <br>не подписанных клиентами</span><span class='top-info-line-value'>{{docs_not_signed_by_clients}}</span></div>
        </div>
      </div>
  
    {%elif request.user.profile.role.title == 'Врач'%}
    {%else%}
    {%endif%}
    <div class="col-md-12 col-lg-12">
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Аналитика документов в системе</h3>
        </div>
        <table class="table card-table table-vcenter">
          <thead>
            <tr>
              <th>Название документов</th>
              <th>Всего документов</th>
              <th>Подписано / не подписано<br> клиентами</th>
              <th>Подписано / не подписано<br> врачами</th>
<!--                        <th></th>-->
            </tr>
          </thead>
          <tbody>
            {% for type in types %}
              <tr>
                <td><a href="{%url 'category' type.id %}">{{type.title}}</a></td>
                <td>{{type.document.count}}</td>
                <td>{{type.signed_by_patient}} / {{type.document.count|sub:type.signed_by_patient}}</td>
                <td>{{type.signed_by_doctor}} / {{type.document.count|sub:type.signed_by_doctor}}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h2 style="margin-bottom: inherit;">Последние документы</h2>
        </div>
        <div class="card-body border-bottom py-3">
          <div class="d-flex">
          </div>
        </div>
        <div class="table-responsive">
          <table class="table card-table table-vcenter text-nowrap datatable">
            <thead>
              <tr>
                <th class="w-1">No. <!-- Download SVG icon from http://tabler-icons.io/i/chevron-up -->
                  <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm text-dark icon-thick" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"></path><polyline points="6 15 12 9 18 15"></polyline></svg>
                </th>
                <th>Тип документа</th>
                <th>Отправитель</th>
                <th>Создатель</th>
                <th>Пациент</th>
                <th>Дата</th>
                <th>Статус Пациента</th>
                <th>Статус врача</th>
                <th></th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            {%for document in all_active_documents%}
              <tr>
                <td><span class="text-muted">{{document.id}}</span></td>
                <td><span class="text-muted">{{document.type}}</span></td>
                <td><span class="text-muted">{{document.founder}}</span></td>
                <td><a href="{%url 'user' document.sender.pk %}" class="text-reset" tabindex="-1">{{document.sender.first_name}} {{document.sender.last_name}}</a></td>
                <td>
                  <a href="{% url 'user' document.recipient.pk %}">{{document.recipient.first_name}} {{document.recipient.last_name}}</a>
                </td>
                <td>
                  {{document.send_date}}

                </td>
                <td>
                  {%if document.recipient_status%}
                  <span class="badge bg-success me-1"></span>
                  Подписан
<!--                            - Клиентом-->
                  {%else%}
                  <span class="badge bg-danger me-1"></span>
                  Не подписан
<!--                            - Клинетом-->
                  {%endif%}

                </td>
                <td>
                  {%if document.sender_status%}
                  <span class="badge bg-success me-1"></span>
                  Подписан
<!--                            - Врачом-->
                  {%else%}
                  <span class="badge bg-danger me-1"></span>
                  Не Подписан
<!--                            - Врачом-->
                  {%endif%}

                </td>
                <td class="text-end">
                  {%if document.sender_status == False and document.sender == request.user or document.recipient_status == False and document.recipient == request.user%}
                    <span class="dropdown">
                    <button class="btn dropdown-toggle align-text-top" data-bs-boundary="viewport" data-bs-toggle="dropdown">
                      Действия
                    </button>
                    <div class="dropdown-menu dropdown-menu-end">
                      <a class="dropdown-item" href="{% url 'sign_document' document.pk %}#">
                        Подписать
                      </a>
                      <a class="dropdown-item" href="{{document.document.url}}#" download>
<!--                                  Anotheraction-->
                        Скачать документ
                      </a>
                      <a class="dropdown-item" href="{{document.document.url}}#">
<!--                                  Anotheraction-->
                        Просмотеть документ
                      </a>
                    </div>
                  </span>
                  {%else%}
                    <span class="dropdown" style="height: 2.4rem;width: 2.4rem;display: flex;justify-content: center;width: 100%;align-items: center;color: #0ea36d;">
                      <!-- Download SVG icon from http://tabler-icons.io/i/checkbox -->
                      <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="9 11 12 14 20 6" /><path d="M20 12v6a2 2 0 0 1 -2 2h-12a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h9" /></svg>
                    </span>
                  {%endif%}
                </td>
              </tr>
            {%endfor%}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
</div>

{%endblock%}